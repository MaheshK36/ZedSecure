name: Build & Release APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.5'
          channel: 'stable'
          cache: true
      
      - name: Flutter Doctor
        run: flutter doctor -v
      
      - name: Install Dependencies
        run: flutter pub get
      
      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_FILE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/zedsecure-release-new.keystore
          echo "âœ… Keystore file created successfully"
      
      - name: Create key.properties
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          echo "storeFile=android/app/zedsecure-release-new.keystore" > key.properties
          echo "storePassword=$KEYSTORE_PASSWORD" >> key.properties
          echo "keyAlias=$KEY_ALIAS" >> key.properties
          echo "keyPassword=$KEY_PASSWORD" >> key.properties
          echo "âœ… key.properties created successfully"
      
      - name: Build APKs (All Architectures)
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: flutter build apk --release --split-per-abi
      
      - name: Get Version
        id: version
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="1.3.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: List Built APKs
        run: |
          echo "ğŸ“¦ Built APK files:"
          ls -lh build/app/outputs/flutter-apk/
      
      - name: Rename APK Files
        run: |
          mkdir -p release-apks
          cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk release-apks/ZedSecure-${{ steps.version.outputs.version }}-arm64-v8a.apk
          cp build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk release-apks/ZedSecure-${{ steps.version.outputs.version }}-armeabi-v7a.apk
          echo "âœ… APK files renamed successfully"
      
      - name: Upload ARM64 APK
        uses: actions/upload-artifact@v4
        with:
          name: ZedSecure-arm64-v8a
          path: release-apks/ZedSecure-${{ steps.version.outputs.version }}-arm64-v8a.apk
      
      - name: Upload ARMv7 APK
        uses: actions/upload-artifact@v4
        with:
          name: ZedSecure-armeabi-v7a
          path: release-apks/ZedSecure-${{ steps.version.outputs.version }}-armeabi-v7a.apk
      
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-apks/ZedSecure-${{ steps.version.outputs.version }}-arm64-v8a.apk
            release-apks/ZedSecure-${{ steps.version.outputs.version }}-armeabi-v7a.apk
          body: |
            ## ğŸš€ ZedSecure VPN ${{ steps.version.outputs.version }}
            
            ### ğŸ“¥ Downloads
            
            **Recommended**: `ZedSecure-${{ steps.version.outputs.version }}-arm64-v8a.apk` (for most modern devices)
            
            - **ARM64-v8a**: For most modern Android devices (2015+) - **RECOMMENDED**
            - **ARMv7a**: For older Android devices (2012-2015)
            
            ### âœ¨ What's New in v1.3.0
            
            #### Major Features
            - ğŸŒ **Real Country Detection**: Automatically detect and display the actual country flag after connecting to VPN
            - ğŸ›¡ï¸ **Custom DNS Settings**: Configure custom DNS servers (Primary & Secondary) in Settings
            - ğŸ¨ **Improved Light Theme**: Fixed blur effects and enhanced aesthetics for light mode
            - ğŸ”„ **Fixed Subscription Duplicate Bug**: Resolved issue where subscription configs were duplicated upon reactivation
            
            #### Updates
            - ğŸ“¦ **Updated Dependencies**: 
              - fluent_ui: 4.13.0
              - http: 1.5.0
              - provider: 6.1.5
              - shared_preferences: 2.5.3
              - connectivity_plus: 7.0.0
              - path_provider: 2.1.5
              - permission_handler: 12.0.1
              - flutter_lints: 6.0.0
              - flutter_launcher_icons: 0.14.4
            
            #### Enhancements
            - ğŸŒ **Country Detection API**: Uses real IP geolocation to show actual VPN location
            - ğŸ”§ **Streamlined DNS Config**: Simplified to Primary & Secondary DNS only
            - ğŸ¨ **Cleaner Light Theme**: Removed glass effects, added clean white cards with subtle shadows
            - ğŸ§¹ **Code Cleanup**: Removed all comments for cleaner codebase
            
            ### ğŸ“ Installation
            
            1. Download the appropriate APK for your device
            2. Enable "Install from Unknown Sources" in Android settings
            3. Install the APK
            4. Grant VPN and notification permissions
            5. Enjoy secure browsing!
            
            ### âš ï¸ Google Play Protect Warning
            
            If you see "App scan recommended" or similar warnings, this is normal for apps not distributed through Google Play Store. The app is **open source** and safe. You can:
            - Click "Install Anyway" or "Install Without Scanning"
            - Or review the source code yourself: https://github.com/CluvexStudio/ZedSecure
            
            ### ğŸ” Security
            
            - âœ… Open Source - Fully transparent code
            - âœ… No data collection or telemetry
            - âœ… Encrypted local storage
            - âœ… GPL-3.0 Licensed
            
            ### ğŸ“– Documentation
            
            - [README](https://github.com/CluvexStudio/ZedSecure/blob/main/README.md)
            - [Build Instructions](https://github.com/CluvexStudio/ZedSecure#-build-from-source)
            - [Contributing Guide](https://github.com/CluvexStudio/ZedSecure/blob/main/CONTRIBUTING.md)
            
            ### ğŸ™ Support
            
            If you find this project helpful, please â­ star the repository!
            
            **Telegram Channel**: https://t.me/CluvexStudio
            
            ---
            
            **Developed by CluvexStudio**  
            *Building open-source tools for digital freedom and privacy*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
